## 중복 시청 방지

### ConflictService

우리 서비스는 하나의 계정으로 둘 이상의 사용자가 중복으로 플레이어를 시청하는 것을 방지한다. 이는 클라이언트 플랫폼의 중요 자산인 영상 데이터의 유출을 막고, 개인 정보를 보호하기 위함이다.

중복 시청 방지 기능을 위해서 이를 전담하는 ConflictService를 구현하였다. 이를 통해 플레이어 내의 프론트엔드 API를 호출할 때마다, 같은 계정으로 중복해서 접속을 시도하는 사용자가 있는지 확인한 후, 적절한 조치를 취하고 있다.

중복 시청 방지를 구현하기 위해서, ActiveAccessToken이라는 redis 엔티티를 구현했다.

ActiveAccessToken은 사용자가 플레이어 실행 API를 호출하면 redis-server에 생성되고, 플레이어를 종료하면 제거된다. 로그인/로그아웃과는 별개로 동작하며, 하나의 계정으로 플레이어 실행 API를 두 번 호출하면 서로 다른 두 개의 ActiveAccessToken이 생성되기 때문에 중복 시청 방지를 감지하는 플래그 역할을 하게 된다.

<img width="512" alt="Untitled (51)" src="https://user-images.githubusercontent.com/45627010/235287029-f0c477c3-9d34-45f2-8b4b-0b35015f3916.png">

ActiveAccessToken의 필드 중 conflict는 해당 토큰의 충돌 상태를 기록한다. 

conflict가 0인 경우, 중복 시청이 일어나지 않은 상태임을 의미한다. conflict가 1인 경우는 같은 계정으로 중복 시청이 발생하였으며, 해당 토큰이 먼저 플레이어에 접속한 토큰임을 의미한다. conflict가 2인 경우는 같은 계정으로 중복 시청이 발생하였으며, 해당 토큰이 나중에 플레이어에 접속한 토큰임을 의미한다. 

ConflictService에서는 토큰의 conflict를 확인/변경하거나 사용자의 플레이어 이용을 막는 등의 기능을 제공하며 중복 시청을 막는다.

### 정상 접근

일반적인 경우 즉, 중복 시청이 없는 경우 플레이어를 이용할 때 호출되는 API는 다음과 같다.

(참고로 오픈 API는 플랫폼에서 실행하는 API이고, 프론트엔드 API는 플레이어의 프론트엔드에서 내부적으로 호출되는 API이다.)

1. **오픈 API - ‘로그인’ (/open/auth/login)**

    - 유저에게 액세스토큰이 발급됨
2. **오픈 API - ‘플레이어_실행’ (/open/player/execute)**
    - 플레이어 창이 열림
    - 해당 계정에 대해 액티브토큰이 등록됨
        - 중복 시청을 구별하는 토큰
        - 액세스토큰과 별개
3. **프론트엔드 API - ‘플레이어_시작’ (/front/player/start)**
    - 넘겨받은 userId를 통해 현재 시청을 시도하는 유저의 토큰을 확인
4. **각종 프론트엔드 API 호출 (/front/ … )**

### 중복 시청 발생

중복 시청이 발생했을 때, 플레이어의 동작은 다음과 같다. 

플레이어를 이용 중인 사용자 A와, 뒤늦게 동일 계정(test1234)으로 플레이어를 실행한 사용자 B가 있다고 가정하자.

1. **A** : **오픈 API - ‘로그인’**
    - 유저 **A**의 액세스토큰이 발급됨
2. **A** : **오픈 API - ‘플레이어_실행’**
    - 플레이어 창이 열림
    - 해당 계정(test1234)에 대해 액티브토큰이 등록됨
3. **A** : **프론트엔드 API - ‘플레이어_시작’** 
    - 넘겨받은 userId(test1234의 userId)를 통해 현재 시청을 시도하는 유저의 토큰(**A**의 액세스토큰)을 확인
4. **A** : **각종 프론트엔드 API 호출 (/front/ … )**
    - **A**의 액세스토큰으로 API 실행
    
    — — — — — —  사용자 B가 동일 계정으로 접속 — — — — — — 
    
5. **B** : **오픈 API - ‘로그인’**
    - 유저 **B**의 액세스토큰이 발급됨
6. **B** : **오픈 API - ‘플레이어_실행’**
    - 플레이어 창이 열림
    - 해당 계정(test1234)에 대해 액티브토큰이 등록됨
    - **계정 test1234에 대해 현재 두 개의 액티브 토큰이 등록되어 있음 → 중복 시청 감지**
7. **B** : **프론트엔드 API - ‘플레이어_시작’**
    - 넘겨받은 userId(test1234의 userId)를 통해 현재 시청을 시도하는 유저의 토큰(**B**의 액세스토큰)을 확인
8. **B** : **각종 프론트엔드 API 호출 (/front/ … )**
    - **B**의 액세스토큰으로 API 실행
9. **유저 A의 액세스토큰에 제한 걸림**
    - API 실행 시, 중복 시청 감지 에러코드 반환
    - 유저 A의 화면에 중복 시청 감지 메시지를 출력하고, 종료 의사를 물어봄
    - 유저 B는 유저 A가 **오픈 API - ‘충돌_해결’** 로 조치를 취하기 전까지 문제없이 API 이용 가능
10. **A : 오픈 API - ‘충돌_해결’** 
    - keepGoing (request parameter)
        - ture → 사용자 **A**가 계속 이용
            - 사용자 **B**가 API 실행 시, 중복 시청 감지 에러코드 반환
            - 사용자 **B**에 대해 9~10 과정이 진행됨
        - false → 사용자 **B**가 계속 이용
            - 프론트엔드에서 사용자 **A**에 **프론트엔드 API - ‘플레이어_종료’** 를 호출한 후, 플레이어를 종료시킴
